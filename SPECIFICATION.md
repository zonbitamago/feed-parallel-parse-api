# feed-parallel-parse-api システム仕様書

**最終更新日**: 2025-10-29
**バージョン**: v1.0

> **重要**: この仕様書は、PR作成時に必ず更新してください。機能追加・変更があった場合は、該当セクションを修正し、最新の実装状態を反映させることがプロジェクトルールとして定められています。

---

## 1. システム概要

feed-parallel-parse-apiは、複数のRSSフィードを並列に取得・解析し、統合されたタイムラインとして表示するWebアプリケーションです。フロントエンドはReact + TypeScript、バックエンドはGoで構築されており、ブラウザのlocalStorageを使用してクライアントサイドでデータを永続化します。

### 主要機能
- 複数RSSフィードの購読管理（追加・削除・編集）
- フィードタイトルの自動取得とカスタマイズ
- 並列フィード取得による高速な記事取得
- 統合タイムラインでの記事表示
- 仮想スクロールによる高速レンダリング
- キーワード検索とソート機能
- エラーハンドリングとユーザーフィードバック

---

## 2. 技術スタック

### フロントエンド
- **フレームワーク**: React 19.1.1 + TypeScript 5.9.3
- **ビルドツール**: Vite 7.1.7
- **スタイリング**: TailwindCSS 4.x
- **状態管理**: React Context API（UIContext, SubscriptionContext）
- **仮想スクロール**: react-window 1.8.x
- **日付処理**: date-fns 4.x
- **テスト**: Vitest 4.0.3, @testing-library/react 16.3.0
- **CI/CD**: GitHub Actions

### バックエンド
- **言語**: Go 1.25.1
- **RSSパーサー**: github.com/mmcdole/gofeed
- **フォーマット対応**: RSS 1.0, RSS 2.0, Atom
- **HTTPサーバー**: 標準ライブラリ net/http

### データストレージ
- **永続化**: ブラウザ localStorage
- **キャッシュ**: フィードタイトルのインメモリキャッシュ（10分TTL）

---

## 3. フィード購読管理機能

### 3.1 フィード追加

#### 基本フロー
1. ユーザーがRSSフィードのURLを入力
2. URLバリデーション（http/https スキームチェック）
3. 重複チェック（既に登録済みか確認）
4. バックエンドAPIにタイトル取得リクエスト（`POST /api/parse`）
5. フィードタイトルを自動取得して表示
6. localStorageに購読情報を保存

#### URL入力プレビュー機能
- URLを入力するとリアルタイムでフィードタイトルをプレビュー表示
- 取得失敗時は「エラー: 取得に失敗しました」と表示
- デバウンス処理（300ms）により不要なAPI呼び出しを削減

#### エラーハンドリング
- **無効なURL**: 「無効なURLです。http://またはhttps://で始まるURLを入力してください」
- **重複フィード**: 「このフィードは既に登録されています」（入力フィールドはクリアされない）
- **タイトル取得失敗**: 「フィードのタイトルを取得できませんでした。URLをタイトルとして使用します。」（フィード自体は登録され、入力フィールドはクリアされる）
- **購読数上限**: 「購読数が上限（100件）に達しています」

#### データ構造
```typescript
interface Subscription {
  id: string;              // UUID
  url: string;             // フィードURL
  title: string | null;    // 自動取得されたタイトル
  customTitle: string | null; // ユーザーが設定したカスタムタイトル
  subscribedAt: string;    // ISO 8601形式
  lastFetchedAt: string | null;
  status: 'active' | 'error';
}
```

### 3.2 フィードタイトル表示

#### 表示優先順位
1. **customTitle**: ユーザーが手動で設定したタイトル（最優先）
2. **title**: APIから自動取得されたフィードタイトル
3. **url**: タイトル取得に失敗した場合のフォールバック

#### 表示形式
```
[表示名]
URL: https://example.com/feed.xml
```

表示名が元のURLと異なる場合、「URL:」プレフィックスを付けて元URLを明示的に表示します。

### 3.3 フィードタイトル編集

#### 編集フロー
1. 購読リストの各アイテムに「編集」ボタンを表示
2. クリックすると編集モードに切り替わり、インラインで編集可能
3. Enterキーで保存、Escキーでキャンセル
4. カスタムタイトルとして保存され、localStorageに永続化

#### バリデーション
- **空文字**: 「フィード名を入力してください」
- **長すぎるタイトル**: 「フィード名は200文字以内で入力してください」
- 前後の空白は自動トリミング

#### UI/UXの工夫
- 編集開始時に自動フォーカス
- 編集中は「保存」「キャンセル」ボタンを表示
- 編集中は「編集」「削除」ボタンを非表示
- エラーメッセージは赤文字でインライン表示

### 3.4 フィード削除

- 購読リストの各アイテムに「削除」ボタンを表示
- クリックで即座にフィードを削除（確認ダイアログなし）
- localStorageから削除され、UIから即座に消える

---

## 4. 記事表示機能

### 4.1 並列フィード取得

#### 取得アルゴリズム
1. 全購読フィードのURLをバックエンドに送信（`POST /api/parse-multiple`）
2. バックエンドが並列にフィードを取得（Goのgoroutineを使用）
3. 各フィードの記事を統合して返却
4. エラーが発生したフィードは個別に記録

#### タイムアウト設定
- フィード取得タイムアウト: 10秒
- AbortControllerを使用したリクエストキャンセル対応

### 4.2 統合タイムライン表示

#### 記事データ構造
```typescript
interface Article {
  id: string;
  title: string;
  link: string;
  pubDate: string | null;
  summary: string;
  feedId: string;
  feedTitle: string;    // 表示用のフィードタイトル
  feedOrder: number;    // 購読リスト内での順序
}
```

#### デフォルトソート
- **降順（新着順）**: 最新の記事が上に表示
- `pubDate`が存在しない記事は最古として扱われる

#### 仮想スクロール
- react-windowを使用して大量の記事を高速レンダリング
- 各記事の高さ: 120px（固定）
- 表示領域外の記事はDOMから除外され、パフォーマンスを維持

### 4.3 記事カード

#### 表示情報
- **記事タイトル**: クリック可能なリンク
- **要約**: 記事の概要（HTMLタグは除去済み）
- **公開日時**: 「2025年10月29日 14:30」形式（date-fnsでフォーマット）
- **フィード名**: 記事の出典フィード
- **購読順**: フィード購読リスト内での順序番号（「#1」形式）

#### スタイリング
- TailwindCSSによるレスポンシブデザイン
- ホバー時のハイライト効果
- グレー背景のカード形式

---

## 5. 検索・フィルタリング機能

### 5.1 キーワード検索

#### 検索対象
- 記事タイトル
- 記事の要約（summary）
- フィード名

#### 検索アルゴリズム
- 部分一致検索（大文字小文字を区別しない）
- スペース区切りでAND検索に対応
- 日本語・英語両方に対応

#### UI
- 検索ボックスはヘッダーに配置
- リアルタイム検索（入力と同時に結果が更新される）
- 検索結果件数を表示

### 5.2 ソート機能

#### ソートオプション
- **日付（新しい順）**: デフォルト
- **日付（古い順）**: 時系列順に表示
- **フィード順**: 購読リスト内での順序で表示

#### ソート優先順位
1. 選択されたソート条件
2. pubDateがnullの記事は最後に配置（日付ソートの場合）

---

## 6. データ永続化

### 6.1 localStorage管理

#### 保存データ
```typescript
// キー: 'feed-subscriptions'
[
  {
    "id": "uuid-1234",
    "url": "https://example.com/feed.xml",
    "title": "Example Blog",
    "customTitle": "My Custom Title",
    "subscribedAt": "2025-10-29T05:30:00Z",
    "lastFetchedAt": "2025-10-29T06:00:00Z",
    "status": "active"
  }
]
```

#### 永続化タイミング
- フィード追加時
- フィード削除時
- カスタムタイトル編集時

#### データ読み込み
- アプリ起動時にlocalStorageから購読情報を復元
- パースエラー時は空配列として扱う

### 6.2 タイトルキャッシュ

#### キャッシュ戦略
- インメモリキャッシュ（Map構造）
- TTL: 10分
- キャッシュキー: フィードURL

#### キャッシュヒット時の動作
- API呼び出しをスキップし、キャッシュされたタイトルを即座に返却
- プレビュー表示が高速化

---

## 7. エラーハンドリング

### 7.1 フロントエンドエラー

#### バリデーションエラー
- URLフォーマットエラー
- 空文字エラー
- 購読数上限エラー
- タイトル長エラー

#### 表示方法
- 入力フィールド下に赤文字でインライン表示
- `role="alert"`を付与してアクセシビリティ対応
- `aria-invalid`属性で無効状態を明示

### 7.2 バックエンドエラー

#### API通信エラー
- ネットワークエラー
- タイムアウト（10秒）
- HTTPステータスエラー（4xx, 5xx）

#### フィードパースエラー
- 無効なRSSフォーマット
- 空のフィード
- HTTPステータス404/500

#### エラーレスポンス形式
```json
{
  "error": "エラーメッセージ"
}
```

### 7.3 エラーメッセージ一覧

#### フィード取得エラー
- `FETCH_FAILED`: 「フィードの取得に失敗しました」
- `FETCH_FAILED_DISPLAY`: 「エラー: 取得に失敗しました」
- `DUPLICATE_FEED`: 「このフィードは既に登録されています」
- `TITLE_FETCH_FAILED`: 「フィードのタイトルを取得できませんでした。URLをタイトルとして使用します。」

#### URLバリデーションエラー
- `INVALID_URL`: 「無効なURLです」
- `INVALID_URL_DETAILED`: 「無効なURLです。http://またはhttps://で始まるURLを入力してください」

#### タイトルバリデーションエラー
- `EMPTY_TITLE`: 「フィード名を入力してください」
- `TITLE_TOO_LONG`: 「フィード名は200文字以内で入力してください」

#### 購読数制限エラー
- `LIMIT_REACHED`: 「購読数が上限（100件）に達しています」

---

## 8. API仕様

### 8.1 エンドポイント一覧

#### `POST /api/parse`
単一のRSSフィードを取得してタイトルを返却します。

**リクエスト**:
```json
{
  "url": "https://example.com/feed.xml"
}
```

**レスポンス（成功）**:
```json
{
  "title": "Example Blog"
}
```

**レスポンス（エラー）**:
```json
{
  "error": "failed to fetch feed: 404 Not Found"
}
```

#### `POST /api/parse-multiple`
複数のRSSフィードを並列に取得して統合記事リストを返却します。

**リクエスト**:
```json
{
  "feeds": [
    {
      "id": "uuid-1",
      "url": "https://example.com/feed.xml",
      "feedOrder": 0
    },
    {
      "id": "uuid-2",
      "url": "https://another.com/rss",
      "feedOrder": 1
    }
  ]
}
```

**レスポンス（成功）**:
```json
{
  "articles": [
    {
      "id": "article-1",
      "title": "記事タイトル",
      "link": "https://example.com/article-1",
      "pubDate": "2025-10-29T05:30:00Z",
      "summary": "記事の要約",
      "feedId": "uuid-1",
      "feedTitle": "Example Blog",
      "feedOrder": 0
    }
  ],
  "errors": [
    {
      "url": "https://another.com/rss",
      "message": "failed to parse feed",
      "timestamp": "2025-10-29T06:00:00Z"
    }
  ]
}
```

### 8.2 対応フォーマット

- **RSS 1.0** (RDF/RSS)
- **RSS 2.0**
- **Atom**

### 8.3 パフォーマンス仕様

- 並列フィード取得により、N個のフィードをO(1)時間で取得
- 各フィードのタイムアウト: 10秒
- タイトルキャッシュTTL: 10分

---

## 9. UI/UX設計

### 9.1 レスポンシブデザイン

- TailwindCSSのユーティリティクラスを使用
- モバイル・タブレット・デスクトップに対応
- フレキシブルレイアウト

### 9.2 アクセシビリティ

#### ARIA属性
- `role="alert"`: エラーメッセージ
- `aria-invalid`: 無効な入力フィールド
- `aria-describedby`: エラーメッセージとの関連付け
- `aria-label`: ボタンのラベル

#### キーボード操作
- Enterキー: フォーム送信、編集保存
- Escapeキー: 編集キャンセル
- Tabキー: フォーカス移動

### 9.3 ウェルカム画面

- フィードが0件の場合、ウェルカムメッセージを表示
- 使い方ガイドとサンプルURLを提示
- フィード追加後は自動で非表示

---

## 10. テスト・品質保証

### 10.1 テストカバレッジ

- **全体**: 93.2%（目標80%を達成）
  - Statement: 93.2%
  - Branch: 87.17%
  - Function: 98.42%
  - Line: 93.67%

### 10.2 テスト種別

#### ユニットテスト
- コンポーネント単体テスト
- ユーティリティ関数テスト
- バリデーション関数テスト

#### 統合テスト
- フィード追加フロー
- タイトル編集フロー
- エラーハンドリング
- プレビュー機能

#### E2Eテスト
- （オプション、未実装）

### 10.3 CI/CD

#### GitHub Actions
- プッシュ時に自動実行
- Lintチェック（ESLint）
- 型チェック（TypeScript）
- テスト実行（Vitest）
- カバレッジレポート生成

#### コード品質基準
- ESLint警告: 0件
- TypeScriptビルドエラー: 0件
- テストカバレッジ: 80%以上

---

## 11. 制約・制限事項

### 11.1 システム制約

- **購読数上限**: 100件
- **タイトル最大長**: 200文字
- **フィード取得タイムアウト**: 10秒
- **タイトルキャッシュTTL**: 10分

### 11.2 ブラウザ要件

- モダンブラウザ（Chrome, Firefox, Safari, Edge最新版）
- localStorage対応必須
- JavaScript有効化必須

### 11.3 既知の制限

- オフラインモードなし（ネットワーク必須）
- 認証・ユーザー管理なし（シングルユーザー）
- フィード更新の自動通知なし（手動リフレッシュ）

---

## 12. セキュリティ

### 12.1 入力検証

- URLスキーム検証（http/https のみ許可）
- XSS対策（Reactのデフォルトエスケープ）
- 入力長制限（タイトル200文字）

### 12.2 CORS対策

- バックエンドでCORS設定
- オリジン検証（本番環境では要設定）

### 12.3 レート制限

- （現状未実装、将来的に検討）

---

## 13. 今後の拡張案

- 自動更新機能（ポーリング）
- 記事の既読管理
- カテゴリ・タグ機能
- エクスポート/インポート機能
- マルチユーザー対応
- プッシュ通知

---

## 付録A: データフロー図

```
[ユーザー]
  ↓ URL入力
[FeedManager]
  ↓ onAddFeed()
[FeedContainer]
  ↓ POST /api/parse
[バックエンドAPI]
  ↓ RSSフィード取得
[外部RSSサーバー]
  ↓ レスポンス
[バックエンドAPI]
  ↓ タイトル返却
[FeedContainer]
  ↓ localStorage保存
[SubscriptionContext]
  ↓ UI更新
[FeedManager]
```

---

## 付録B: 状態管理

### Context構造

#### UIContext
```typescript
{
  showWelcomeScreen: boolean;
  searchQuery: string;
  sortOrder: 'newest' | 'oldest' | 'feed-order';
}
```

#### SubscriptionContext
```typescript
{
  subscriptions: Subscription[];
}
```

### Reducer Actions

#### UIContext
- `SET_WELCOME_SCREEN`
- `SET_SEARCH_QUERY`
- `SET_SORT_ORDER`

#### SubscriptionContext
- `ADD_SUBSCRIPTION`
- `REMOVE_SUBSCRIPTION`
- `UPDATE_CUSTOM_TITLE`

---

以上が現在のfeed-parallel-parse-apiシステムの全体仕様です。