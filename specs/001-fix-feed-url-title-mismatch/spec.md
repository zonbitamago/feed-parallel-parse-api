# Feature Specification: 複数RSSフィード登録時のURL/タイトル不一致バグ修正

**Feature Branch**: `001-fix-feed-url-title-mismatch`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "複数RSSフィード登録時のURL/タイトル不一致バグ修正"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 複数フィード登録時に正しいタイトルとURLが表示される (Priority: P1)

ユーザーが複数のRSSフィードを登録した際、各フィードのURLとタイトルの組み合わせが正しく表示される。現在、3個目以降のフィード登録時にURLとタイトルの紐付けが誤っている問題を修正する。

**Why this priority**: これはクリティカルなバグであり、ユーザーが登録したフィードを正しく識別できない状態にある。データの正確性に直接影響するため最優先で修正が必要。

**Independent Test**: 3つ以上のRSSフィードを登録し、各フィードのURL欄に表示されるタイトルが実際にそのURLから取得したタイトルと一致することを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが既に2つのフィードを登録している状態で、**When** 3つ目の異なるRSSフィードURLを追加する、**Then** 3つ全てのフィードについて、表示されるタイトルが各URLから実際に取得されたタイトルと一致する
2. **Given** 空の状態から、**When** 5つの異なるRSSフィードを連続して登録する、**Then** 登録された全てのフィードについて、URLとタイトルの組み合わせが正しく表示される
3. **Given** 複数のフィードが登録済みの状態で、**When** ページをリロードする、**Then** 永続化されたデータから復元された際も、全てのフィードのURLとタイトルの組み合わせが正しい

---

### User Story 2 - URLマッチング失敗時の適切なエラーハンドリング (Priority: P2)

API応答のフィードURLと購読リストのURLが一致しない場合でも、システムが不正確なマッチングを行わず、適切にエラーを処理する。

**Why this priority**: データの整合性を保つために重要だが、P1のバグ修正が完了すればほとんどのケースでマッチングは成功するため、P2とする。

**Independent Test**: 購読リストのURLとAPI応答のフィードURLが意図的に異なる状態を作り、システムがインデックスフォールバックを使用せず、マッチング失敗を適切にログ出力または処理することを確認する。

**Acceptance Scenarios**:

1. **Given** 購読リストに登録されたURLがAPI応答のフィードURLと完全一致しない（正規化の違いなど）、**When** フィード取得を実行する、**Then** システムは不正確なマッチングを行わず、マッチング失敗を記録する
2. **Given** URLマッチングが失敗した状態で、**When** ユーザーがフィード一覧を確認する、**Then** 誤ったタイトルが表示されることなく、フォールバック値（URLまたは前回のタイトル）が表示される

---

### User Story 3 - URL正規化によるマッチング精度の向上 (Priority: P3)

末尾スラッシュの有無、プロトコルの違い（http/https）、www prefixの有無、ドメインの大文字小文字などの微妙な違いがあっても、URLが同一のフィードとして認識される。

**Why this priority**: ユーザー体験の向上には寄与するが、P1のバグ修正が最優先であり、正規化はその後の品質改善として位置づける。

**Independent Test**: 同じフィードを指す異なる形式のURL（例: `https://example.com/feed` と `https://example.com/feed/`）を登録し、システムが同一フィードとして正しくマッチングすることを確認する。

**Acceptance Scenarios**:

1. **Given** 購読リストに `http://example.com/feed` が登録されている、**When** API応答が `https://example.com/feed/` を返す、**Then** URL正規化により同一フィードとして認識され、正しくマッチングされる
2. **Given** 購読リストに `http://www.EXAMPLE.COM/feed` が登録されている、**When** API応答が `https://example.com/feed` を返す、**Then** プロトコル・www・大文字小文字の正規化により、正しくマッチングされる

---

### Edge Cases

- API応答の順序が購読リストの順序と完全に異なる場合（並列処理による順序不定）でも、正しくマッチングされるか？
- 同一URLのフィードが複数登録されている場合、どのように処理するか？
- API応答のフィード数が購読リストの数と異なる場合（一部のフィードがエラー）、正常なフィードは正しくマッチングされるか？
- フィードのlinkフィールドが空またはnullの場合、システムはどう処理するか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、フィード取得API応答と購読リストのマッチング時に、URLの完全一致による紐付けを実行しなければならない
- **FR-002**: システムは、URLマッチングが失敗した場合、インデックスベースのフォールバック処理を使用してはならない
- **FR-003**: システムは、URLマッチング失敗時に、失敗理由をログ出力しなければならない（デバッグ支援）
- **FR-004**: システムは、URL正規化機能を実装し、以下の要素を統一してマッチング精度を向上させなければならない：
  - プロトコル（http/https → httpsに統一）
  - ドメインの大文字小文字（小文字化）
  - www prefixの有無（除去）
  - 末尾スラッシュの有無（除去）
  - クエリパラメータは保持される
- **FR-005**: システムは、マッチング失敗したフィードについて、購読データのタイトルを更新せず、既存のタイトル（またはURL）を保持しなければならない
- **FR-006**: システムは、API応答の順序に依存せず、URL正規化後の値でフィードを識別しなければならない
- **FR-007**: システムは、全てのフィード登録操作（1個目、2個目、3個目以降）で一貫した動作をしなければならない

### Key Entities

- **Subscription（購読情報）**: ユーザーが登録したRSSフィードの情報。url（登録したURL）、title（取得したフィードタイトル）、id（一意識別子）を含む
- **RSSFeed（API応答フィード）**: バックエンドAPIから返されるフィードデータ。link（フィードのURL）、title（フィードタイトル）、articles（記事リスト）を含む
- **URLマッチングロジック**: SubscriptionのurlとRSSFeedのlinkを照合し、正しいフィードを特定する処理

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 3個以上のRSSフィードを登録した際、100%のケースで各フィードのURLとタイトルが正しく表示される
- **SC-002**: API応答の順序が購読リストと異なる場合でも、URL正規化により95%以上のケースで正しくマッチングされる
- **SC-003**: URLマッチング失敗時に、不正確なタイトル表示が0件となる（誤ったフィードとの紐付けが発生しない）
- **SC-004**: 既存のフィード登録機能（1〜2個の登録）に対して、動作の後退がない（リグレッションテストで100%パス）
