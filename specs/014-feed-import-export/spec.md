# Feature Specification: 購読フィードのインポート/エクスポート機能

**Feature Branch**: `014-feed-import-export`
**Created**: 2025-11-02
**Status**: Draft
**Input**: User description: "購読フィードのインポート/エクスポート機能を実装する。JSONファイル形式でエクスポート（全データを含む：id、URL、タイトル、カスタムタイトル、購読日時、最終取得日時、ステータス）。JSONファイルからインポート（既存データとマージ：URLの重複チェック、重複しないものだけ追加）。FeedManagerコンポーネント内にエクスポート/インポートボタンを配置。インポート時に何件追加されたか、何件スキップされたか（重複）を表示。ファイル形式の検証とエラーハンドリング（不正なJSON、スキーマ不一致、ファイルサイズ超過など）。"

## User Scenarios & Testing

### User Story 1 - 購読フィードのエクスポート (Priority: P1)

ユーザーとして、現在購読しているフィード一覧をファイルとしてダウンロードしたい。これにより、別のデバイスへの移行、バックアップ、他のRSSリーダーへの移行準備ができる。

**Why this priority**: データのバックアップ機能は、ユーザーがアプリケーションを信頼して使い続けるための基本的な要件。購読フィードが多いユーザーほど、データ損失のリスクを気にするため、エクスポート機能は必須。

**Independent Test**: 購読フィードが5件ある状態で、エクスポートボタンをクリックし、ダウンロードされたJSONファイルに全5件のフィードデータ（id、URL、タイトル、カスタムタイトル、購読日時、最終取得日時、ステータス）が含まれることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが3件のフィードを購読している、**When** エクスポートボタンをクリックする、**Then** 「subscriptions_YYYY-MM-DD.json」という名前でJSONファイルがダウンロードされる
2. **Given** エクスポートボタンがクリックされる、**When** ダウンロードが完了する、**Then** JSONファイルには全てのフィールド（id、url、title、customTitle、subscribedAt、lastFetchedAt、status）が含まれる
3. **Given** 購読フィードが0件の状態、**When** エクスポートボタンをクリックする、**Then** 空の購読リスト（{"subscriptions": []}）を含むJSONファイルがダウンロードされる
4. **Given** カスタムタイトルを設定したフィードが含まれる、**When** エクスポートする、**Then** customTitleフィールドが正しくJSONに含まれる

---

### User Story 2 - 購読フィードのインポート（マージ方式） (Priority: P1)

ユーザーとして、以前エクスポートしたフィードリストをインポートしたい。既に購読しているフィードと重複しないように、新しいフィードだけを追加してほしい。

**Why this priority**: デバイス移行時や誤ってデータを削除した場合のリカバリーに不可欠。マージ方式により、既存のフィードを失うことなく、新しいフィードだけを追加できる。

**Independent Test**: 既に2件のフィードを購読している状態で、5件のフィード（うち2件は既存と同じURL）を含むJSONファイルをインポートし、結果として合計5件（既存2件+新規3件）になることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが2件のフィードを購読している、**When** 5件のフィードを含むJSONファイルをインポートする（うち2件は既存と同じURL）、**Then** 重複しない3件だけが追加され、合計5件になる
2. **Given** インポートが完了する、**When** 結果が表示される、**Then** 「3件のフィードを追加しました。2件のフィードは既に購読済みのためスキップしました。」というメッセージが表示される
3. **Given** 全てのフィードが既に購読済み、**When** インポートする、**Then** 「0件のフィードを追加しました。5件のフィードは既に購読済みのためスキップしました。」と表示される
4. **Given** インポートしたフィードにカスタムタイトルが含まれる、**When** インポートが完了する、**Then** カスタムタイトルも正しく復元される

---

### User Story 3 - インポート時のファイル検証とエラーハンドリング (Priority: P1)

ユーザーとして、不正なファイルをインポートしようとした場合、分かりやすいエラーメッセージを表示してほしい。システムが壊れたり、データが破損したりしないようにしてほしい。

**Why this priority**: データの整合性を保つために不可欠。不正なデータによるシステム障害やデータ破損を防ぐことは、ユーザー体験の基本。

**Independent Test**: テキストファイル、巨大なJSONファイル（2MB）、不正な形式のJSONファイルをそれぞれインポートし、各ケースで適切なエラーメッセージが表示され、既存データが影響を受けないことを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがテキストファイル（.txt）を選択する、**When** インポートを試みる、**Then** 「JSONファイルを選択してください」というエラーメッセージが表示される
2. **Given** 不正なJSON形式のファイルを選択する、**When** インポートを試みる、**Then** 「ファイル形式が正しくありません。有効なJSONファイルを選択してください。」と表示される
3. **Given** 正しいJSON形式だがスキーマが不一致（subscriptionsフィールドがない）、**When** インポートを試みる、**Then** 「データ形式が正しくありません。エクスポートされたフィードファイルを選択してください。」と表示される
4. **Given** ファイルサイズが1MBを超える、**When** インポートを試みる、**Then** 「ファイルサイズが大きすぎます（最大1MB）」と表示される
5. **Given** URLフィールドが欠落しているフィードが含まれる、**When** インポートを試みる、**Then** 「データ形式が正しくありません。」と表示され、インポートが中止される
6. **Given** エラーが発生する、**When** インポート処理が失敗する、**Then** 既存の購読フィードデータは変更されない

---

### User Story 4 - UI配置とアクセシビリティ (Priority: P2)

ユーザーとして、エクスポート/インポート機能を簡単に見つけて使いたい。FeedManager画面で、購読フィード一覧の近くにボタンがあると分かりやすい。

**Why this priority**: UIの使いやすさは重要だが、機能の正確性（P1）よりは優先度が低い。ボタンの配置は後から調整可能。

**Independent Test**: FeedManager画面を開き、「エクスポート」「インポート」ボタンが購読フィード一覧の上部に表示され、クリックできることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがFeedManager画面を開く、**When** 画面を確認する、**Then** 購読フィード一覧の上部に「エクスポート」「インポート」ボタンが表示される
2. **Given** エクスポートボタンをクリックする、**When** ダウンロードが開始される、**Then** 即座にファイルがダウンロードされる（モーダルやダイアログは不要）
3. **Given** インポートボタンをクリックする、**When** ファイル選択ダイアログが開く、**Then** .jsonファイルのみが選択可能なフィルタが適用される
4. **Given** モバイルデバイスで画面を表示する、**When** ボタンをタップする、**Then** タッチ操作で正しくエクスポート/インポートができる

---

### Edge Cases

- 同じURLのフィードだが、カスタムタイトルが異なる場合、どちらを優先するか？（既存のカスタムタイトルを維持）
- インポート中にネットワークエラーやブラウザクラッシュが発生した場合、どのようにロールバックするか？（インポート前に検証を完了し、一括で適用する）
- 古いバージョンのエクスポートファイル（スキーマが異なる）をインポートした場合、どのように対応するか？（スキーマバージョンチェックを実装し、マイグレーション機能を提供）
- 非常に大量のフィード（1000件以上）をインポートした場合、パフォーマンスはどうなるか？（バッチ処理で対応し、進捗表示を追加）
- ブラウザのlocalStorageの容量制限（通常5MB）を超える場合、どのように対応するか？（事前にストレージ容量をチェックし、エラーメッセージを表示）

## Requirements

### Functional Requirements

- **FR-001**: システムは「エクスポート」ボタンをFeedManagerコンポーネント内の購読フィード一覧の上部に配置すること
- **FR-002**: システムは「インポート」ボタンをFeedManagerコンポーネント内の購読フィード一覧の上部に配置すること
- **FR-003**: エクスポート機能は現在の全購読フィードをJSON形式でダウンロードすること
- **FR-004**: エクスポートされるJSONファイルには以下のフィールドを含むこと：id、url、title、customTitle、subscribedAt、lastFetchedAt、status
- **FR-005**: エクスポートファイル名は「subscriptions_YYYY-MM-DD.json」形式（日付は実行日）とすること
- **FR-006**: インポート機能はJSONファイルのみを受け付けること（.json拡張子）
- **FR-007**: インポート時にファイルサイズが1MBを超える場合、エラーメッセージを表示してインポートを中止すること
- **FR-008**: インポート時にJSONパースが失敗した場合、「ファイル形式が正しくありません」とエラーメッセージを表示すること
- **FR-009**: インポート時にスキーマ検証を実施し、必須フィールド（subscriptions配列、各フィードのurl）が欠落している場合、エラーメッセージを表示すること
- **FR-010**: インポート時に既存のフィードとURLで重複チェックを行い、重複するフィードはスキップすること
- **FR-011**: インポート時に重複しないフィードのみをlocalStorageに追加すること
- **FR-012**: インポート完了後、「X件のフィードを追加しました。Y件のフィードは既に購読済みのためスキップしました。」というメッセージを表示すること
- **FR-013**: インポート処理中にエラーが発生した場合、既存の購読フィードデータを変更しないこと（ロールバック）
- **FR-014**: エクスポート/インポート機能はブラウザの標準File APIを使用すること
- **FR-015**: インポートしたフィードのIDは新規生成すること（エクスポート元のIDは使用しない）
- **FR-016**: インポートしたフィードのsubscribedAtは現在日時に設定すること
- **FR-017**: インポートしたフィードのlastFetchedAtはnullに設定すること（初回フェッチが必要）
- **FR-018**: インポートしたフィードのstatusは'active'に設定すること

### Key Entities

- **Subscription（購読フィード）**: フィードの購読情報を表すエンティティ
  - id: 一意識別子（UUID）
  - url: フィードのURL（重複チェックのキー）
  - title: フィードのタイトル（自動取得）
  - customTitle: ユーザーが設定したカスタムタイトル（任意）
  - subscribedAt: 購読開始日時（ISO 8601形式）
  - lastFetchedAt: 最終フェッチ日時（ISO 8601形式、未フェッチの場合null）
  - status: フィード状態（'active' | 'error'）

- **ExportData（エクスポートデータ）**: エクスポートファイルの形式
  - subscriptions: Subscription配列

- **ImportResult（インポート結果）**: インポート処理の結果
  - addedCount: 追加されたフィード数
  - skippedCount: スキップされたフィード数（重複）
  - message: ユーザーに表示するメッセージ

## Success Criteria

### Measurable Outcomes

- **SC-001**: ユーザーは1クリックで全購読フィードをJSONファイルとしてダウンロードできる
- **SC-002**: エクスポートされたファイルには全てのフィールド（id、url、title、customTitle、subscribedAt、lastFetchedAt、status）が含まれる
- **SC-003**: インポート時に100件のフィードを含むファイルを処理できる（1秒以内）
- **SC-004**: インポート時に不正なファイル（非JSON、スキーマ不一致、サイズ超過）を検出し、適切なエラーメッセージを表示する
- **SC-005**: インポート時にURLベースで重複チェックを行い、既存フィードを保護する（重複0件）
- **SC-006**: インポート完了後、追加件数とスキップ件数を明確に表示する
- **SC-007**: インポート処理中のエラーにより既存データが破損することがない（ロールバック成功率100%）
- **SC-008**: エクスポート/インポートボタンがFeedManager画面で視認しやすい位置に配置される
- **SC-009**: モバイルデバイスでもエクスポート/インポート機能が正しく動作する

## Assumptions

- ブラウザはFile API（FileReader、Blob、URL.createObjectURL）をサポートしている
- localStorageの容量制限（通常5MB）内で購読フィードデータを保存できる
- インポートするJSONファイルは信頼できるソース（同じアプリケーションのエクスポート機能）から生成されたものである
- ユーザーは自分がエクスポートしたファイルをインポートすることが主な用途である
- フィードのURLは一意性を保証するキーとして使用できる（同じURLのフィードは同一とみなす）
- インポート時にフィードのタイトルを再取得する必要はない（エクスポートデータのタイトルをそのまま使用）
- インポート/エクスポート機能は頻繁に使用される機能ではない（週に1回未満）

## Out of Scope

以下はこの機能の範囲外とします：

- OPML形式のサポート（将来的に追加する可能性はあるが、このバージョンではJSON形式のみ）
- 他のRSSリーダーとの直接的な互換性（Feedly、Inoreaderなど）
- クラウドストレージへの自動バックアップ
- インポート時のフィードタイトルの再検証や更新
- インポート時のプログレスバー表示（100件程度であれば瞬時に完了するため不要）
- エクスポートファイルの暗号化やパスワード保護
- 複数のエクスポートファイルを一度にインポートする機能
- インポート履歴の記録や管理
- エクスポートファイルのバージョン管理（将来的にスキーマが変更された場合のマイグレーション機能は別機能として実装）
