# Feature Specification: 実際のHTTP GETによるRSSフィード取得

**Feature Branch**: `007-real-http-fetch`
**Created**: 2025-10-27
**Status**: Draft
**Input**: User description: "apiのフィード取得部分をダミーレスポンスではなく、実際のhttp getに変更する"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 実際のRSSフィードの取得 (Priority: P1)

ユーザーが実際のRSSフィードURLを指定すると、システムは該当のURLからフィードコンテンツを取得し、パースした記事データを返す。現在のダミーレスポンスではなく、実際のウェブサイトからデータを取得する。

**Why this priority**: これは本機能の中核であり、実際のRSSフィードを扱えなければサービスとして成立しない。P1として最優先で実装すべき。

**Independent Test**: 有効なRSSフィードURL（例: https://example.com/feed.xml）をPOSTリクエストで送信し、実際のフィードコンテンツがパースされて返されることを確認することで独立してテストできる。

**Acceptance Scenarios**:

1. **Given** 有効なRSSフィードURLが1つ指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** 実際のフィードコンテンツが取得され、パースされた記事データが返される
2. **Given** 複数の有効なRSSフィードURLが指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** 全てのURLから並列にフィードコンテンツが取得され、パースされたデータが返される

---

### User Story 2 - HTTPエラーハンドリング (Priority: P2)

ユーザーが指定したRSSフィードURLが無効、到達不可、またはHTTPエラーを返す場合、システムは適切なエラーメッセージをユーザーに返し、他の有効なフィードの処理は継続する。

**Why this priority**: 実運用では必ずネットワークエラーや無効なURLが発生するため、適切なエラーハンドリングは必須。ただし、基本的なフィード取得が動作することが前提なのでP2とする。

**Independent Test**: 無効なURL（404エラーを返すURLなど）を含むリクエストを送信し、該当URLにはエラー情報が返され、他の有効なURLは正常に処理されることを確認することで独立してテストできる。

**Acceptance Scenarios**:

1. **Given** 存在しないURL（404エラー）が指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** エラー情報（URL、HTTPステータスコード、エラーメッセージ）が返される
2. **Given** タイムアウトするURL（応答が遅いサーバー）が指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** タイムアウトエラーが返される
3. **Given** 1つの無効なURLと2つの有効なURLが指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** 無効なURLにはエラー情報が返され、有効なURLからは正常にデータが取得される

---

### User Story 3 - ネットワークタイムアウト設定 (Priority: P3)

ユーザーがフィードを取得する際、システムは適切なタイムアウト時間を設定し、応答が遅いサーバーに対して無限に待機しないようにする。

**Why this priority**: システムの安定性とレスポンス時間を保証するために重要だが、基本機能が動作した後に最適化できるのでP3とする。

**Independent Test**: 意図的に遅いレスポンスを返すモックサーバーに対してリクエストを送信し、設定されたタイムアウト時間内にエラーが返されることを確認することで独立してテストできる。

**Acceptance Scenarios**:

1. **Given** 応答が設定タイムアウト時間を超えるURLが指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** タイムアウトエラーが返される
2. **Given** 応答が設定タイムアウト時間内に完了するURLが指定された状態で、**When** APIにPOSTリクエストを送信すると、**Then** 正常にデータが取得される

---

### Edge Cases

- 有効なURLだがRSS形式ではないコンテンツ（HTMLページなど）が返された場合はどうなるか？
- リダイレクトされるURLの場合、システムは自動的にフォローするか？
- 非常に大きなフィード（数千件の記事を含む）を取得する場合、メモリやパフォーマンスの問題は発生しないか？
- HTTPSとHTTPの両方のURLをサポートするか？
- 認証が必要なプライベートフィードの場合はどう処理するか？
- ネットワーク接続がない場合、または一時的にネットワークが不安定な場合はどうなるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは指定されたRSSフィードURLに対して実際のHTTP GETリクエストを実行しなければならない
- **FR-002**: システムは複数のRSSフィードURLを並列に取得しなければならない（現在の並行処理は維持）
- **FR-003**: システムはHTTP GETリクエストに対して適切なタイムアウト時間を設定しなければならない（デフォルト: 10秒）
- **FR-004**: システムはHTTPエラー（4xx、5xx）が発生した場合、該当URLのエラー情報を返さなければならない
- **FR-005**: システムはネットワークエラー（DNS解決失敗、接続タイムアウトなど）が発生した場合、適切なエラーメッセージを返さなければならない
- **FR-006**: システムはHTTPリダイレクト（301、302など）を自動的にフォローしなければならない（最大リダイレクト回数: 10回）
- **FR-007**: システムはHTTP/HTTPSの両方のプロトコルをサポートしなければならない
- **FR-008**: システムは取得したコンテンツが有効なRSS/Atom形式であることを確認し、無効な場合はエラーを返さなければならない
- **FR-009**: システムは各URLの処理結果（成功またはエラー）を個別に返さなければならない（1つのURLの失敗が他のURLの処理に影響しない）
- **FR-010**: システムは現在のパース機能（Atom、RSS2.0、RSS1.0サポート）を維持しなければならない

### Key Entities

- **HTTPレスポンス**: RSSフィードURLから取得される生のHTTPレスポンスデータ（ステータスコード、ヘッダー、ボディを含む）
- **エラー情報**: 取得失敗時の詳細情報（URL、HTTPステータスコード、エラーメッセージ、エラータイプ）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが有効なRSSフィードURLを指定すると、実際のフィードコンテンツが取得され、5秒以内にパース結果が返される
- **SC-002**: システムは10個のRSSフィードURLを並列に処理し、全て正常な場合は15秒以内に全ての結果を返す
- **SC-003**: 無効なURLまたはエラーを返すURLに対して、適切なエラーメッセージ（URL、ステータスコード、エラー内容）が返される
- **SC-004**: 応答が10秒を超えるサーバーに対して、タイムアウトエラーが返される
- **SC-005**: システムは正常なURLとエラーURLが混在する場合でも、正常なURLからはデータを取得し、エラーURLにはエラー情報を返す（エラー隔離）

## Assumptions

- ほとんどのRSSフィードサーバーは10秒以内に応答を返すため、デフォルトタイムアウトは10秒とする
- リダイレクトは最大10回まで許可することで、無限ループを防ぎつつ一般的なリダイレクトチェーンに対応する
- 基本認証やOAuthが必要なプライベートフィードは本機能のスコープ外とし、将来的な拡張として検討する
- コンテンツサイズの上限は設定しないが、実装時にメモリ使用量を考慮する必要がある
- User-Agentヘッダーは適切に設定し、RSSフィード提供者がボットとして識別できるようにする

## Dependencies

- 現在の `pkg/services/rss_service.go` の `ParseFeeds` メソッドの並行処理構造を維持する
- 現在のエラーハンドリングメカニズム（`models.ErrorInfo`）を利用する
- 既存のパーサー（`AtomParser`、`RSS2Parser`、`RDFParser`）はそのまま使用する

## Out of Scope

- フィードコンテンツのキャッシュ機能（将来的な拡張として検討）
- 認証が必要なプライベートフィードのサポート
- フィードの更新頻度を自動検出する機能
- リトライロジック（初回失敗時の自動再試行）
- レート制限やリクエスト数の制御