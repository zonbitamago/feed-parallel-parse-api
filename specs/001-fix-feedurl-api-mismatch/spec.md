# 機能仕様書: API応答にfeedUrlフィールド追加によるマッチング精度改善

**機能ブランチ**: `001-fix-feedurl-api-mismatch`
**作成日**: 2025-11-01
**ステータス**: ドラフト
**入力**: ユーザー説明: "Fix API response to include feedUrl field for accurate feed matching. Currently API returns feed.link (homepage URL) instead of the actual RSS feed URL, causing matching failures in frontend."

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー1 - フィード登録後の記事表示 (優先度: P1) 🎯 MVP

ユーザーがRSSフィード（例: https://feeds.rebuild.fm/rebuildfm）を登録したとき、システムはそのフィードの全記事を登録直後に表示しなければならない。

**この優先度の理由**: これは中核機能である。これが動作しないと、ユーザーは一切の記事を閲覧できない。現在の本番環境のバグは、100%のフィード記事表示をブロックしている。

**独立テスト**: 任意のRSSフィードURLを登録し、そのフィードの記事が5秒以内に記事リストに表示されることを確認する。

**受け入れシナリオ**:

1. **前提** ユーザーはフィードを1つも登録していない、**操作** "https://feeds.rebuild.fm/rebuildfm"を登録する、**期待結果** Rebuild.fmの記事が記事リストに表示される
2. **前提** ユーザーは既に2つのフィードを登録している、**操作** 3つ目のフィードを登録する、**期待結果** 3つ全てのフィードの記事が正しく表示される
3. **前提** 50件の記事を持つRSSフィードがある、**操作** そのフィードを登録する、**期待結果** 50件全ての記事が表示される

---

### ユーザーストーリー2 - 正しいフィードタイトルの表示 (優先度: P2)

ユーザーがRSSフィードを登録したとき、システムは各記事の横に正しいフィードタイトル（RSSメタデータから取得）を表示しなければならず、不一致のタイトルを表示してはならない。

**この優先度の理由**: ユーザーは各記事がどのフィードから来たかを区別する必要がある。誤ったタイトルは混乱を招くが、中核機能はブロックしない。

**独立テスト**: 異なるタイトルを持つ3つのフィードを登録し、各記事が正しいフィードタイトルバッジを表示することを確認する。

**受け入れシナリオ**:

1. **前提** ユーザーが"https://feeds.rebuild.fm/rebuildfm"を登録する、**操作** 記事が読み込まれる、**期待結果** 全てのRebuild.fm記事がフィードタイトルとして"Rebuild"を表示する
2. **前提** ユーザーが5つのフィードを登録している、**操作** 記事リストを閲覧する、**期待結果** 各記事がその元フィードのタイトルを正確に表示する

---

### ユーザーストーリー3 - フィードURL正規化との互換性 (優先度: P3)

API応答に実際のRSSフィードURL（feedUrl）が含まれる場合、フロントエンドのURL正規化ロジック（末尾スラッシュ、http/https、www prefixの違いを処理）と互換性がなければならない。

**この優先度の理由**: 様々なURL形式での堅牢性を確保するが、基本機能より重要度は低い。

**独立テスト**: 様々なURL形式（末尾スラッシュあり/なし、http vs https）でフィードを登録し、マッチングが正しく動作することを確認する。

**受け入れシナリオ**:

1. **前提** APIがfeedUrl="https://example.com/rss/"を返す、**操作** ユーザーが"https://example.com/rss"（末尾スラッシュなし）を登録した、**期待結果** マッチングが成功し記事が表示される
2. **前提** APIがfeedUrl="http://example.com/feed"を返す、**操作** ユーザーが"https://example.com/feed"を登録した、**期待結果** プロトコルの違いにもかかわらずマッチングが成功する

---

### エッジケース

- gofeedパーサー出力で`feed.FeedLink`が空またはnullの場合はどうなるか？（リクエストされたURLへのフォールバック）
- `feed.Link`（ホームページ）と`feed.FeedLink`（RSS URL）が同一のフィードをシステムはどう処理するか？
- RSSフィードが異なるrel属性を持つ複数の`<link>`要素を返す場合はどうなるか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: API応答は実際のRSSフィードURL（リクエスト/パースされたURL）を含む`feedUrl`フィールドを含まなければならない
- **FR-002**: APIはgofeedパーサーが提供する`feed.FeedLink`フィールドから`feedUrl`を設定しなければならない
- **FR-003**: APIは後方互換性のため既存の`link`フィールド（`feed.Link`からのホームページURL）を保持しなければならない
- **FR-004**: `feed.FeedLink`が空の場合、APIは元々リクエストされたURLを`feedUrl`として使用しなければならない
- **FR-005**: フロントエンドは購読情報とAPI応答のマッチングに`feedUrl`を使用しなければならない（`link`ではなく）
- **FR-006**: URLマッチングロジックは比較前に購読URLと`feedUrl`値の両方に正規化を適用しなければならない

### 主要エンティティ *(機能がデータを含む場合)*

- **RSSFeed (API応答)**: パースされたRSSフィードを表現:
  - `title`: RSSメタデータからのフィードタイトル
  - `link`: RSS `<link>`要素からのホームページURL
  - `feedUrl`: **新規** - 実際のRSSフィードURL（`feed.FeedLink`またはリクエストURLから）
  - `articles`: 記事オブジェクトの配列

- **Subscription (フロントエンド)**: ユーザーが登録したフィードを表現:
  - `url`: ユーザーが入力したRSSフィードURL
  - その他のメタデータ（title、subscribedAtなど）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 登録されたRSSフィードの100%が登録後5秒以内に記事を表示する
- **SC-002**: URLが正規化のみで異なる場合（末尾スラッシュ、プロトコル、www prefix）、フィード-購読マッチングが100%成功する
- **SC-003**: デプロイ後、「フィードマッチング失敗」に関連する本番エラーがゼロになる
- **SC-004**: 更新されたAPI応答構造で既存の自動テストが全て継続してパスする
- **SC-005**: 5つの実世界のRSSフィード（Rebuild.fm含む）での手動テストで100%の記事表示成功率を示す

## 前提条件

- gofeedライブラリの`feed.FeedLink`フィールドは、ほとんどのRSS/Atomフィードで実際のRSSフィードURLを確実に含む
- フロントエンドのURL正規化関数は全てのエッジケースを正しく処理する（PR #17で既に検証済み）
- `link`フィールドとの後方互換性が必要（システムの他の部分がホームページURLに依存している可能性）
- API利用者（フロントエンド）はAPIデプロイと同時に更新可能

## スコープ外

- URL正規化ロジックの変更（PR #17で既に実装・テスト済み）
- フロントエンド購読ストレージ形式の変更
- `feedUrl`以外の新規フィールドのAPI応答への追加
- 既存ユーザーデータやlocalStorageの移行（API応答は動的に生成される）

## 依存関係

- フロントエンドデプロイの前または同時にGoバックエンドのデプロイが必要
- 現在使用中のgofeedライブラリバージョンに依存（`feed.FeedLink`をサポートしていると仮定）
- フロントエンドの変更は更新されたAPI応答スキーマに依存

## セキュリティ & プライバシーへの考慮

- 新しいセキュリティリスクは導入されない（既存のAPI応答にデータフィールドを追加するのみ）
- `feedUrl`はユーザー固有のデータを含まない（同じフィードの全ユーザーに同じURLが見える）
- 認証や認可の変更は不要
