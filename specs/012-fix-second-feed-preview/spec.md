# Feature Specification: 2件目フィード購読時のプレビュー表示バグ修正

**Feature Branch**: `012-fix-second-feed-preview`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "2件目のRSSフィード購読時にプレビュー（タイトルフェッチ）が表示されないバグを修正。原因はFeedManager.tsxのuseEffect依存配列にonClearErrorが含まれていることで、1件目追加後の状態変化により2件目入力時にuseEffectが正常に再実行されない。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 2件目以降のフィード追加時のプレビュー表示 (Priority: P1)

ユーザーが既に1件のRSSフィードを購読している状態で、2件目のフィードを追加しようとする際に、URL入力欄に新しいフィードのURLを入力すると、そのフィードのタイトルがプレビューとして表示される。これにより、ユーザーは追加しようとしているフィードが正しいものかを確認できる。

**現在の問題**:
- 1件目のフィード追加後、2件目のURL入力時にプレビュー（タイトルフェッチ）が表示されない
- `/api/feed/parse` へのリクエストが送信されない
- ブラウザのコンソールにエラーメッセージも表示されない

**根本原因**:
- `FeedManager.tsx`のuseEffect（99-121行目）の依存配列に`onClearError`が含まれている
- 1件目追加後、親コンポーネントの再レンダリングで`onClearError`の参照が変わる可能性がある
- useEffectが再実行されるが、その時点で`url`は空文字列（既にクリア済み）
- `if (!url)`に入り、`clearPreview()`のみ実行して早期リターン
- 2件目のURL入力時、`url`は変化しているが`onClearError`の参照が変わらず、useEffectが再実行されない

**Why this priority**: ユーザーがフィードを追加する際の基本的なフィードバック機能であり、1件目のフィード追加では正常に動作するため、2件目以降でも同様に動作すべきである。このバグはユーザー体験を著しく損ね、誤ったフィードの購読につながる可能性がある。

**Independent Test**: 1件目のフィードを追加した後、2件目のフィードURLを入力し、プレビュー（フィードタイトル）が表示されることを確認する。ブラウザの開発者ツールで`/api/feed/parse`へのリクエストが送信されていることを検証する。

**Acceptance Scenarios**:

1. **Given** ユーザーが既に1件のRSSフィードを購読している状態で、**When** URL入力欄に2件目の有効なフィードURLを入力する、**Then** 500ms後にそのフィードのタイトルがプレビューとして表示される
2. **Given** ユーザーが既に1件のRSSフィードを購読している状態で、**When** URL入力欄に2件目の有効なフィードURLを入力する、**Then** `/api/feed/parse`へのAPIリクエストが送信される
3. **Given** ユーザーが既に1件のRSSフィードを購読している状態で、**When** URL入力欄に2件目の無効なURLを入力する、**Then** エラーメッセージが表示され、プレビューは表示されない
4. **Given** ユーザーが既に1件のRSSフィードを購読している状態で、**When** URL入力欄に2件目のURLを入力中（デバウンス期間中）に追加ボタンをクリックする、**Then** プレビュー表示は中断され、フィードが追加される
5. **Given** ユーザーが既に複数件（2件以上）のRSSフィードを購読している状態で、**When** URL入力欄に新しいフィードURLを入力する、**Then** プレビューが正常に表示される

---

### Edge Cases

- **1件目追加直後に2件目を入力**: URL入力欄がクリアされた直後に新しいURLを入力しても、プレビューが正常に表示される
- **プレビュー表示中に追加ボタンをクリック**: デバウンス期間中（500ms以内）に追加ボタンをクリックした場合、プレビュー取得がキャンセルされ、フィード追加処理が優先される
- **無効なURLから有効なURLへの修正**: 無効なURL（エラー表示）から有効なURLに修正した場合、エラーメッセージがクリアされ、プレビューが表示される
- **同じURLを2回追加しようとした場合**: 重複エラーが表示され、プレビューは表示されない（既存の動作を維持）
- **連続して複数件（3件、4件...）のフィードを追加**: 何件目であっても、プレビューが正常に表示される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーが2件目以降のRSSフィードURLを入力した際に、そのフィードのタイトルをプレビューとして表示しなければならない
- **FR-002**: システムは、ユーザーがURL入力欄に有効なフィードURLを入力した際、既存のフィード購読数に関わらず、`/api/feed/parse`へのAPIリクエストを送信しなければならない
- **FR-003**: システムは、URL入力欄の値（`url`）が変更された際にプレビュー取得処理を実行しなければならず、依存する他の状態の変更によって意図しないタイミングでプレビュー処理が実行されてはならない
- **FR-004**: システムは、1件目のフィード追加機能に影響を与えずに、このバグを修正しなければならない（既存の動作を維持）
- **FR-005**: システムは、無効なURLが入力された場合、エラーメッセージを表示し、プレビュー取得処理を実行してはならない（既存の動作を維持）

### Technical Context (for understanding only)

このバグ修正では、以下の技術的な変更が必要です（実装の詳細であり、要件ではありません）：

- `FeedManager.tsx`のuseEffect（99-121行目）の依存配列から`onClearError`を削除
- `onClearError`は条件付きで呼ばれるコールバックであり、その参照の変更でuseEffectを再実行する必要はない
- useEffectは`url`、`fetchPreview`、`clearPreview`の変更時のみ実行されるべき

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが2件目のRSSフィードURLを入力した際、500ms以内にプレビュー（フィードタイトル）が表示される
- **SC-002**: ユーザーが連続して10件のRSSフィードを追加した場合、各フィード追加時に毎回プレビューが正常に表示される（何件目であっても動作が一貫している）
- **SC-003**: 既存のテストスイート（`useFeedPreview.test.ts`、`feedPreviewFlow.test.tsx`など）が全て合格する（既存機能に影響がない）
- **SC-004**: 2件目のフィードURL入力時に、ブラウザの開発者ツールのNetworkタブで`/api/feed/parse`へのリクエストが確認できる
- **SC-005**: 1件目のフィード追加時の動作が変更されていない（プレビュー表示、追加処理、エラーハンドリングが全て正常）

### User Experience Goals

- ユーザーは、何件目のフィードを追加する場合でも、同じようにプレビューを確認できる
- ユーザーは、追加しようとしているフィードが正しいものかを、フィードタイトルのプレビューで確認できる
- ユーザーは、フィード追加のたびに一貫した体験を得られる（1件目と2件目以降で動作が異なることに気づかない）

## Assumptions

- ユーザーは、フィード追加時にプレビューが表示されることを期待している
- 既存のプレビュー機能（`useFeedPreview.ts`、デバウンス処理、AbortController）は正常に動作している
- 親コンポーネント（`FeedContainer.tsx`）から渡される`onClearError`の参照が、1件目のフィード追加後に変更される可能性がある
- このバグ修正は、既存のテストコードの修正を必要としない（既存のテストが合格することで、バグ修正の正当性が確認できる）

## Out of Scope

このバグ修正では、以下は対象外です：

- プレビュー機能の新機能追加（例：画像のプレビュー、記事数の表示など）
- デバウンス時間（500ms）の変更
- プレビュー表示のUI/UXの改善
- 他のコンポーネントのバグ修正（このバグに直接関係しない修正）
- 新しいテストケースの追加（既存のテストが合格することを確認するのみ）
